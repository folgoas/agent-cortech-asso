import streamlit as st\nimport google.generativeai as genai\nfrom notion_client import Client\nimport pandas as pd\nimport requests\nimport datetime\nimport time\nimport threading\nfrom urllib.parse import quote\n\n# ==============================================================================\n# 1. CONFIGURATION & SECRETS\n# ==============================================================================\ntry:\n    # R√©cup√©ration des cl√©s\n    NOTION_KEY = st.secrets[\"NOTION_KEY\"]\n    NOTION_DB_TASKS = st.secrets[\"NOTION_DB_TASKS_ID\"]\n    NOTION_DB_RAPPELS = st.secrets[\"NOTION_DB_RAPPELS_ID\"]\n    GEMINI_KEY = st.secrets[\"GEMINI_KEY\"]\n    BREVO_KEY = st.secrets[\"BREVO_KEY\"]\n    # Optionnel\n    MACRODROID_URL = st.secrets.get(\"MACRODROID_URL\", \"\") \n    \n    # Emails\n    SENDER_EMAIL = st.secrets[\"SENDER_EMAIL\"]\n    TEST_DESTINATAIRE = st.secrets[\"TEST_DESTINATAIRE\"]\nexcept Exception as e:\n    st.error(f\"‚ö†Ô∏è CL√âS MANQUANTES ! Veuillez configurer les 'Secrets'.\\nErreur: {e}\")\n    st.stop()\n\n# Init API Clients\nnotion = Client(auth=NOTION_KEY)\ngenai.configure(api_key=GEMINI_KEY)\n\n# ==============================================================================\n# 2. CERVEAU IA (PROMPT SYST√àME)\n# ==============================================================================\nSYSTEM_PROMPT = \"\"\"\nTu es l'IA centrale de l'association Cor-Tech √† Cordemais.\nTu remplaces les b√©n√©voles manquants. Tu es autonome, proactif et expert tech.\n\nTES MISSIONS :\n1. ADMINISTRATIF : R√©diger emails, PV d'AG, dossiers subventions, synth√®ses PDF.\n2. COM : Cr√©er posts FB/LinkedIn/Twitter, newsletters HTML, communiqu√©s presse.\n3. TECH : Expert 3D, Arduino, Code, Gaming. Tu peux d√©bugger et expliquer.\n4. GESTION : Planning salles, gestion b√©n√©voles, id√©es ateliers.\n5. VISUEL : Tu sais d√©crire des images pour les g√©n√©rer.\n\nTON STYLE :\n- Pro mais sympa (Esprit Maker/Asso).\n- Tu signes \"Ton Assistant Cor-Tech ü§ñ\".\n- Tu utilises le contexte de l'asso (Lutte fracture num√©rique, Gaming, Labo Ludik).\n\"\"\"\n\n# ==============================================================================\n# 3. FONCTIONS TECHNIQUES\n# ==============================================================================\n\ndef send_email_brevo(sujet, html_content, to_email):\n    \"\"\"Envoie un mail HTML via Brevo\"\"\"\n    url = \"https://api.brevo.com/v3/smtp/email\"\n    payload = {\n        \"sender\": {\"name\": \"IA Cor-Tech\", \"email\": SENDER_EMAIL},\n        \"to\": [{\"email\": to_email}],\n        \"subject\": sujet,\n        \"htmlContent\": f\"<html><body>{html_content}</body></html>\"\n    }\n    headers = {\"api-key\": BREVO_KEY, \"content-type\": \"application/json\"}\n    try:\n        r = requests.post(url, json=payload, headers=headers)\n        return r.status_code == 201\n    except:\n        return False\n\ndef send_sms_android(numero, message):\n    \"\"\"Envoie un SMS via passerelle Android (MacroDroid)\"\"\"\n    if not MACRODROID_URL: return False\n    try:\n        clean_num = numero.replace(\" \", \"\").replace(\".\", \"\")\n        params = {\"param1\": clean_num, \"param2\": message}\n        requests.get(MACRODROID_URL, params=params)\n        return True\n    except:\n        return False\n\ndef generate_image_url(prompt):\n    \"\"\"G√©n√®re une image via Pollinations\"\"\"\n    encoded = quote(prompt)\n    return f\"https://image.pollinations.ai/prompt/{encoded}?nologo=true\"\n\ndef add_notion_task(nom, responsable, priorite, frequence):\n    try:\n        notion.pages.create(\n            parent={\"database_id\": NOTION_DB_TASKS},\n            properties={\n                \"Nom\": {\"title\": [{\"text\": {\"content\": nom}}]},\n                \"Responsable\": {\"rich_text\": [{\"text\": {\"content\": responsable}}]},\n                \"Priorite\": {\"select\": {\"name\": priorite}},\n                \"Frequence\": {\"select\": {\"name\": frequence}},\n                \"Statut\": {\"status\": {\"name\": \"√Ä faire\"}}\n            }\n        )\n        return True\n    except: return False\n\ndef add_notion_rappel(msg, dest, jour):\n    try:\n        notion.pages.create(\n            parent={\"database_id\": NOTION_DB_RAPPELS},\n            properties={\n                \"Message\": {\"title\": [{\"text\": {\"content\": msg}}]},\n                \"Destinataire\": {\"rich_text\": [{\"text\": {\"content\": dest}}]},\n                \"Jour\": {\"select\": {\"name\": jour}},\n                \"Actif\": {\"checkbox\": True}\n            }\n        )\n        return True\n    except: return False\n\n# ==============================================================================\n# 4. MOTEUR D'AUTOMATISATION\n# ==============================================================================\n@st.cache_resource\ndef start_daily_scheduler():\n    def scheduler_loop():\n        print(\"‚è∞ D√©marrage du Cron Job interne...\")\n        last_check_date = None\n        while True:\n            now = datetime.datetime.now()\n            today_str = now.strftime(\"%Y-%m-%d\")\n            if last_check_date != today_str and now.hour >= 9:\n                print(f\"--- T√¢ches auto du {today_str} ---\")\n                jours_fr = [\"Lundi\", \"Mardi\", \"Mercredi\", \"Jeudi\", \"Vendredi\", \"Samedi\", \"Dimanche\"]\n                jour_actuel = jours_fr[now.weekday()]\n                try:\n                    query = notion.databases.query(\n                        database_id=NOTION_DB_RAPPELS,\n                        filter={\"and\": [{\"property\": \"Actif\", \"checkbox\": {\"equals\": True}}, {\"property\": \"Jour\", \"select\": {\"equals\": jour_actuel}}]}\n                    )\n                    results = query.get(\"results\", [])\n                    for page in results:\n                        props = page[\"properties\"]\n                        msg = props[\"Message\"][\"title\"][0][\"text\"][\"content\"]\n                        dest = props[\"Destinataire\"][\"rich_text\"][0][\"text\"][\"content\"]\n                        send_email_brevo(f\"üîî Rappel Cor-Tech : {msg}\", f\"<p>C'est {jour_actuel}, pense √† : <b>{msg}</b></p>\", dest)\n                        print(f\"‚úÖ Rappel envoy√© √† {dest}\")\n                except Exception as e:\n                    print(f\"‚ùå Erreur Scheduler : {e}\")\n                last_check_date = today_str\n            time.sleep(3600) \n    t = threading.Thread(target=scheduler_loop, daemon=True)\n    t.start()\n    return t\n\nstart_daily_scheduler()\n\n# ==============================================================================\n# 5. INTERFACE GRAPHIQUE\n# ==============================================================================\nst.set_page_config(page_title=\"Cor-Tech OS\", page_icon=\"ü§ñ\", layout=\"wide\")\n\nst.title(\"üöÄ Cor-Tech : Centre de Commandement\")\nst.caption(\"Agent Autonome Actif ‚Ä¢ Surveillance des rappels en cours...\")\n\ntabs = st.tabs([\"üí¨ Assistant\", \"üõ†Ô∏è T√¢ches\", \"‚è∞ Rappels\", \"‚öôÔ∏è Admin\"])\n\n# --- TAB 1 : CHAT ---\nwith tabs[0]:\n    st.info(\"üí° Commandes : 'Visuel pour l'atelier', 'R√©dige un mail', 'Synth√©tise'...\")\n    if \"messages\" not in st.session_state: st.session_state.messages = []\n    for msg in st.session_state.messages:\n        with st.chat_message(msg[\"role\"]):\n            if \"image\" in msg: st.image(msg[\"image\"])\n            st.markdown(msg[\"content\"])\n            \n    if prompt := st.chat_input(\"Votre ordre ?\"):\n        st.session_state.messages.append({\"role\": \"user\", \"content\": prompt})\n        with st.chat_message(\"user\"): st.markdown(prompt)\n        \n        # --- MOD√àLE GEMINI 1.5 FLASH (Plus stable) ---\n        model = genai.GenerativeModel('gemini-1.5-flash')\n        \n        if \"visuel\" in prompt.lower() or \"affiche\" in prompt.lower() or \"image\" in prompt.lower():\n            prompt_img_gen = f\"Cr√©e une description en anglais courte (prompt) pour g√©n√©rer une image : {prompt}\"\n            img_desc = model.generate_content(prompt_img_gen).text\n            img_url = generate_image_url(img_desc)\n            with st.chat_message(\"assistant\"):\n                st.image(img_url, caption=\"Visuel g√©n√©r√© par IA\")\n                st.markdown(f\"[T√©l√©charger]({img_url})\")\n            st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"Visuel g√©n√©r√©.\", \"image\": img_url})\n        else:\n            try:\n                response = model.generate_content(f\"{SYSTEM_PROMPT}\\nHistorique: {st.session_state.messages}\\nUser: {prompt}\")\n                with st.chat_message(\"assistant\"): st.markdown(response.text)\n                st.session_state.messages.append({\"role\": \"assistant\", \"content\": response.text})\n            except Exception as e:\n                st.error(f\"Erreur Gemini : {e}\")\n\n# --- TAB 2 : TACHES ---\nwith tabs[1]:\n    with st.form(\"tache\"):\n        c1, c2 = st.columns(2)\n        n = c1.text_input(\"Quoi faire ?\")\n        r = c2.text_input(\"Qui ?\", \"S√©bastien\")\n        p = c1.selectbox(\"Priorit√©\", [\"Moyenne\", \"Haute\", \"Urgente\"])\n        f = c2.selectbox(\"Fr√©quence\", [\"Ponctuel\", \"Hebdo\"])\n        if st.form_submit_button(\"Ajouter\"):\n            if add_notion_task(n, r, p, f): st.success(\"‚úÖ T√¢che ajout√©e\")\n            else: st.error(\"Erreur Notion\")\n\n# --- TAB 3 : RAPPELS ---\nwith tabs[2]:\n    with st.form(\"rappel\"):\n        c1, c2 = st.columns(2)\n        m = c1.text_input(\"Message\")\n        d = c2.text_input(\"Email\", TEST_DESTINATAIRE)\n        j = st.selectbox(\"Jour\", [\"Lundi\", \"Mardi\", \"Mercredi\", \"Jeudi\", \"Vendredi\", \"Samedi\", \"Dimanche\"])\n        if st.form_submit_button(\"Programmer\"):\n            if add_notion_rappel(m, d, j): st.success(\"‚úÖ Rituel programm√©\")\n            else: st.error(\"Erreur Notion\")\n\n# --- TAB 4 : ADMIN ---\nwith tabs[3]:\n    c1, c2 = st.columns(2)\n    if c1.button(\"üìß Test Email\"):\n        if send_email_brevo(\"Test Agent\", \"<h1>√áa marche !</h1>\", TEST_DESTINATAIRE): st.success(\"Email OK\")\n        else: st.error(\"Erreur Email\")\n    if c2.button(\"üì± Test SMS\"):\n        if MACRODROID_URL:\n            num = st.text_input(\"Num√©ro\")\n            if num and st.button(\"Envoyer\"):\n                send_sms_android(num, \"Test SMS\")\n        else: st.warning(\"Pas de MacroDroid configur√©\")\n
